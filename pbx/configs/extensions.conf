; ============================================================
; SmartCMS Dialplan
; ============================================================

[general]
static=yes
writeprotect=yes
clearglobalvars=yes

[globals]
; Global variables
TRUNK_MAX_DURATION=3600
RECORDING_DIR=/var/spool/asterisk/monitor

; ============================================================
; Context: invalid - reject unmatched
; ============================================================
[invalid]
exten => _X.,1,NoOp(Invalid call from ${CALLERID(all)} to ${EXTEN})
 same => n,Hangup(21)

exten => _.,1,Hangup(21)

; ============================================================
; Context: internal - Extension to Extension calls
; ============================================================
[internal]
; Match any extension number (3-6 digits)
exten => _XXX,1,NoOp(Internal call: ${CALLERID(num)} -> ${EXTEN})
 same => n,Set(CALLERID(name)=${CALLERID(name)})
 same => n,Dial(PJSIP/${EXTEN},30,tTkKHhC)
 same => n,Goto(s-${DIALSTATUS},1)

exten => _XXXX,1,NoOp(Internal call: ${CALLERID(num)} -> ${EXTEN})
 same => n,Set(CALLERID(name)=${CALLERID(name)})
 same => n,Dial(PJSIP/${EXTEN},30,tTkKHhC)
 same => n,Goto(s-${DIALSTATUS},1)

exten => _XXXXX,1,NoOp(Internal call: ${CALLERID(num)} -> ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30,tTkKHhC)
 same => n,Goto(s-${DIALSTATUS},1)

exten => _XXXXXX,1,NoOp(Internal call: ${CALLERID(num)} -> ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30,tTkKHhC)
 same => n,Goto(s-${DIALSTATUS},1)

; Dial status handlers
exten => s-NOANSWER,1,Voicemail(${EXTEN}@default,u)
 same => n,Hangup()

exten => s-BUSY,1,Voicemail(${EXTEN}@default,b)
 same => n,Hangup()

exten => s-CHANUNAVAIL,1,Playback(number-not-reachable)
 same => n,Hangup()

exten => s-CONGESTION,1,Congestion(10)
 same => n,Hangup()

; ============================================================
; Context: from-pstn - Inbound from Trunks/SBCs
; ============================================================
[from-pstn]
exten => _X.,1,NoOp(PSTN Inbound: CID=${CALLERID(all)} DID=${EXTEN})
 same => n,Set(CDR(did)=${EXTEN})
 same => n,Goto(internal,${EXTEN},1)

exten => s,1,NoOp(PSTN Inbound (no DID): CID=${CALLERID(all)})
 same => n,Answer()
 same => n,Playback(tt-allbusy)
 same => n,Hangup()

; ============================================================
; Context: from-internal - Outbound from Extensions
; ============================================================
[from-internal]
include => internal

; Outbound via trunk (prefix 9)
exten => _9.,1,NoOp(Outbound: ${CALLERID(num)} -> ${EXTEN:1})
 same => n,Set(OUTNUM=${EXTEN:1})
 same => n,Goto(outbound-trunk,${OUTNUM},1)

; Outbound via trunk (prefix 0 for local)
exten => _0.,1,NoOp(Outbound Local: ${CALLERID(num)} -> ${EXTEN})
 same => n,Goto(outbound-trunk,${EXTEN},1)

; ============================================================
; Context: outbound-trunk - Route to trunks
; ============================================================
[outbound-trunk]
; This context is dynamically managed by CMS
; Default: try all trunks
exten => _X.,1,NoOp(Outbound Trunk: ${EXTEN})
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 same => n,Hangup(34)

; ============================================================
; Context: turret-intercom - Intercom/Speaker bus
; ============================================================
[turret-intercom]
exten => _X.,1,NoOp(Intercom: ${CALLERID(num)} -> ${EXTEN})
 same => n,SIPAddHeader(Alert-Info: Auto Answer)
 same => n,Dial(PJSIP/${EXTEN},20,A(beep))
 same => n,Hangup()

; ============================================================
; Context: turret-group - Group talk (speaker bus)
; ============================================================
[turret-group]
exten => _X.,1,NoOp(Group Talk: ${CALLERID(num)} -> Group ${EXTEN})
 same => n,ConfBridge(${EXTEN},default_bridge,default_user)
 same => n,Hangup()

; ============================================================
; Context: vpw - Virtual Private Wire (point-to-point)
; ============================================================
[vpw]
exten => _X.,1,NoOp(VPW Call: ${CALLERID(num)} -> ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},0,tTkK)
 same => n,Hangup()

; ============================================================
; Context: conferences
; ============================================================
[conferences]
exten => _X.,1,NoOp(Conference: ${CALLERID(num)} -> Room ${EXTEN})
 same => n,ConfBridge(${EXTEN})
 same => n,Hangup()

; ============================================================
; Context: default (catch-all)
; ============================================================
[default]
include => internal
